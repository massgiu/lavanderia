<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Public+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-gray-50 group/design-root overflow-x-hidden" style='font-family: "Public Sans", "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#eaedf1] px-10 py-3">
          <div class="flex items-center gap-4 text-[#101418]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z"
                  fill="currentColor"
                ></path>
              </svg>
            </div>
            <h2 class="text-[#101418] text-lg font-bold leading-tight tracking-[-0.015em]">Lava e Piega</h2>
          </div>
          <div class="flex flex-1 justify-end gap-8">
            <div class="flex items-center gap-9">
              <a class="text-[#101418] text-sm font-medium leading-normal cursor-default" href="#">Cruscotto</a>
              <a class="text-[#101418] text-sm font-medium leading-normal cursor-default" href="#">Ordini</a>
              <a id="navClienti" class="text-[#101418] text-sm font-medium leading-normal cursor-pointer hover:text-gray-500 disabled-link" href="#">Clienti</a>
              <a id="navPrezzi" class="text-[#101418] text-sm font-medium leading-normal cursor-pointer hover:text-gray-500 disabled-link" href="#">Prezzi</a>
              <a id="navImpostazioniAdmin" class="text-[#101418] text-sm font-medium leading-normal cursor-pointer hover:text-gray-500 disabled-link" href="#">Impostazioni</a>
            </div>
            <button id="notificationButton" title="Notifications"
              class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 bg-[#eaedf1] hover:bg-gray-200 text-[#101418] gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5 disabled-link"
            >
              <div class="text-[#101418]" data-icon="Bell" data-size="20px" data-weight="regular">
                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                  <path
                    d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                  ></path>
                </svg>
              </div>
            </button>
            <div id="userAvatar" title="User Profile"
              class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 cursor-pointer disabled-link"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAofed2fa6jGzyWz-xrMm1uHuJFwA1Lup1LWWzUkCTLXQtVbROk1ZFQ3CdoTmK_nm4WoeZ2fugoD2jGaEEyfYZ7TkRG24tNbRkHI6ujBfjYbQUfE4IsoJPest2FzEfBXHXnyjX8ITPqYhZKGpVKq2RQ0JpVr3bCXIcjVBjVI49x75PGirc0i-v0bJLvSxf_dujqJj4ul6k-_RY9hbfEFAEEymrKaD8a9SAfoaQ0VuVXT35CxnSvgetQwF2cx_9fzIGaFu-plFKaToM");'
            ></div>
            <button id="logoutButton" class="ml-4 flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 bg-[#f76161] hover:bg-red-700 text-white text-sm font-bold leading-normal tracking-[0.015em]">
              <span class="truncate">Logout</span>
            </button>
          </div>
        </header>
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-wrap justify-between gap-3 p-4 items-center">
              <p class="text-[#101418] tracking-light text-[32px] font-bold leading-tight min-w-72">Pannello Ordini</p>
              <button id="newOrderButton"
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 bg-[#b2cbe5] hover:bg-blue-600 text-[#101418] hover:text-white text-sm font-bold leading-normal tracking-[0.015em]"
              >
                <span class="truncate">Nuovo Ordine</span>
              </button>
            </div>
            <div id="dashboardMessage" class="p-4 text-center rounded-md"></div>
            <div class="pb-3">
              <div class="flex border-b border-[#d4dbe2] px-4 gap-8">
                <a class="flex flex-col items-center justify-center border-b-[3px] border-b-[#b2cbe5] text-[#101418] pb-[13px] pt-4 cursor-default" href="#">
                  <p class="text-[#101418] text-sm font-bold leading-normal tracking-[0.015em]">Tutti</p>
                </a>
                <a class="disabled-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#5c728a] hover:border-b-gray-300 pb-[13px] pt-4" href="#">
                  <p class="text-[#5c728a] text-sm font-bold leading-normal tracking-[0.015em]">In Elaborazione</p>
                </a>
                <a class="disabled-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#5c728a] hover:border-b-gray-300 pb-[13px] pt-4" href="#">
                  <p class="text-[#5c728a] text-sm font-bold leading-normal tracking-[0.015em]">Pronto</p>
                </a>
                <a class="disabled-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#5c728a] hover:border-b-gray-300 pb-[13px] pt-4" href="#">
                  <p class="text-[#5c728a] text-sm font-bold leading-normal tracking-[0.015em]">Consegnato</p>
                </a>
              </div>
            </div>
            <div class="px-4 py-3 @container">
              <div class="flex overflow-hidden rounded-xl border border-[#d4dbe2] bg-gray-50">
                <table class="flex-1">
                  <thead>
                    <tr class="bg-gray-50">
                      <th class="px-4 py-3 text-left text-[#101418] w-1/12 text-sm font-medium leading-normal">ID Ordine</th>
                      <th class="px-4 py-3 text-left text-[#101418] w-2/12 text-sm font-medium leading-normal">Cliente</th>
                      <th class="px-4 py-3 text-left text-[#101418] w-2/12 text-sm font-medium leading-normal">Stato</th>
                      <th class="px-4 py-3 text-left text-[#101418] w-2/12 text-sm font-medium leading-normal">Data di Ritiro</th>
                      <th class="px-4 py-3 text-left text-[#101418] w-2/12 text-sm font-medium leading-normal">Data di Consegna</th>
                      <th class="px-4 py-3 text-left text-[#101418] w-1/12 text-sm font-medium leading-normal">Totale</th>
                      <th class="px-4 py-3 text-left text-[#101418] w-1/12 text-[#5c728a] text-sm font-medium leading-normal">Azioni</th>
                    </tr>
                  </thead>
                  <tbody id="ordersTableBody">
                    <!-- Admin order rows will be dynamically inserted here -->
                  </tbody>
                </table>
              </div>
              <!-- Removed inline style for @container as it might not be fully supported or needed for this dynamic table -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- New Order Modal -->
    <div id="newOrderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
      <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3">
          <p class="text-2xl font-bold">Nuovo Ordine</p>
          <button id="closeModalButton" class="text-gray-600 hover:text-gray-900 close-modal text-2xl leading-none">&times;</button>
        </div>
        <form id="newOrderForm">
          <div class="space-y-3">
            <div>
              <label for="userId" class="block text-sm font-medium text-gray-700">User ID Cliente</label>
              <input type="number" id="userId" name="userId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
            </div>
            <div>
              <label for="itemsDescription" class="block text-sm font-medium text-gray-700">Descrizione Articoli</label>
              <textarea id="itemsDescription" name="itemsDescription" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required></textarea>
            </div>
            <div>
              <label for="pickupDate" class="block text-sm font-medium text-gray-700">Data Ritiro (Opzionale)</label>
              <input type="datetime-local" id="pickupDate" name="pickupDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div>
              <label for="deliveryDate" class="block text-sm font-medium text-gray-700">Data Consegna (Opzionale)</label>
              <input type="datetime-local" id="deliveryDate" name="deliveryDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div>
              <label for="totalPrice" class="block text-sm font-medium text-gray-700">Prezzo Totale (€) (Opzionale)</label>
              <input type="number" step="0.01" id="totalPrice" name="totalPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
          </div>
          <div id="newOrderMessage" class="mt-4 text-center p-2 rounded-md"></div>
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" id="cancelOrderButton" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Annulla</button>
            <button type="submit" id="submitNewOrderButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Crea Ordine</button>
          </div>
        </form>
      </div>
    </div>

  </body>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ordersTableBody = document.getElementById('ordersTableBody');
      const dashboardMessage = document.getElementById('dashboardMessage');
      const newOrderButton = document.getElementById('newOrderButton');
      const newOrderModal = document.getElementById('newOrderModal');
      const closeModalButton = document.getElementById('closeModalButton');
      const cancelOrderButton = document.getElementById('cancelOrderButton');
      const newOrderForm = document.getElementById('newOrderForm');
      const newOrderMessage = document.getElementById('newOrderMessage');
      const submitNewOrderButton = document.getElementById('submitNewOrderButton');


      const statusOptions = ['Pending', 'Processing', 'Ready', 'Delivered', 'Cancelled'];

      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        } catch (e) {
          return dateString; // Return raw if parsing fails
        }
      }

      async function updateOrderStatus(orderId, newStatus, selectElement) {
        const originalValue = selectElement.value; // Store original value in case of failure
        selectElement.disabled = true;
        dashboardMessage.textContent = `Aggiornamento stato ordine #${orderId}...`;
        dashboardMessage.className = 'p-4 text-center rounded-md bg-blue-100 border border-blue-300 text-blue-500';
        try {
          const response = await fetch(`/api/admin/orders/${orderId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
          });

          if (response.status === 401 || response.status === 403) {
            window.location.href = 'login.html';
            return;
          }
          
          const result = await response.json();
          if (response.ok) {
            dashboardMessage.textContent = `Stato ordine #${orderId} aggiornato a ${newStatus}.`;
            dashboardMessage.className = 'p-4 text-center rounded-md bg-green-100 border border-green-300 text-green-500';
            selectElement.value = newStatus; // Ensure UI reflects the change
          } else {
            dashboardMessage.textContent = `Errore aggiornamento: ${result.message || response.statusText}`;
            dashboardMessage.className = 'p-4 text-center rounded-md bg-red-100 border border-red-300 text-red-500';
            selectElement.value = order.status; // Revert to original status on failure
          }
        } catch (error) {
          console.error('Error updating status:', error);
          dashboardMessage.textContent = 'Errore di connessione durante l\'aggiornamento.';
          dashboardMessage.className = 'p-4 text-center rounded-md bg-red-100 border border-red-300 text-red-500';
          selectElement.value = order.status; // Revert on catch
        } finally {
            selectElement.disabled = false;
        }
      }

      function createOrderRowElement(order) {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-t-[#d4dbe2]';

        const customerName = order.user ? `${order.user.name || ''} ${order.user.surname || ''}`.trim() : 'Utente Sconosciuto';
        
        let cells = `
          <td class="h-[72px] px-4 py-2 text-[#101418] text-sm font-normal leading-normal">#${order.id}</td>
          <td class="h-[72px] px-4 py-2 text-[#5c728a] text-sm font-normal leading-normal">${customerName}</td>
          <td class="h-[72px] px-4 py-2 text-sm font-normal leading-normal">
            <select data-order-id="${order.id}" class="status-select rounded-md border-gray-300 shadow-sm p-1">
              ${statusOptions.map(status => `<option value="${status}" ${order.status === status ? 'selected' : ''}>${status}</option>`).join('')}
            </select>
          </td>
          <td class="h-[72px] px-4 py-2 text-[#5c728a] text-sm font-normal leading-normal">${formatDate(order.pickup_date)}</td>
          <td class="h-[72px] px-4 py-2 text-[#5c728a] text-sm font-normal leading-normal">${formatDate(order.delivery_date)}</td>
          <td class="h-[72px] px-4 py-2 text-[#5c728a] text-sm font-normal leading-normal">€${order.total_price != null ? order.total_price.toFixed(2) : 'N/A'}</td>
          <td class="h-[72px] px-4 py-2 text-[#5c728a] text-sm font-normal leading-normal">€${order.total_price != null ? order.total_price.toFixed(2) : 'N/A'}</td>
          <td class="h-[72px] px-4 py-2 text-[#5c728a] text-sm font-bold leading-normal tracking-[0.015em]"><a href="#" class="text-blue-600 hover:underline disabled-link" title="Visualizza Dettagli Ordine">Visualizza</a></td>
        `;
        tr.innerHTML = cells;

        const statusSelect = tr.querySelector('.status-select');
        statusSelect.addEventListener('change', (event) => {
          updateOrderStatus(order.id, event.target.value, statusSelect);
        });
        return tr;
      }

      async function fetchAndRenderOrders() {
        if (!ordersTableBody || !dashboardMessage) return;
        dashboardMessage.textContent = 'Caricamento ordini in corso...';
        dashboardMessage.className = 'p-4 text-center rounded-md bg-blue-100 border border-blue-300 text-blue-500';
        ordersTableBody.innerHTML = '';

        try {
          const response = await fetch('/api/admin/orders');
          if (response.status === 401 || response.status === 403) {
            window.location.href = 'login.html';
            return;
          }
          if (!response.ok) {
            const errorResult = await response.json().catch(() => ({ message: response.statusText }));
            dashboardMessage.textContent = `Errore caricamento ordini: ${errorResult.message}`;
            dashboardMessage.className = 'p-4 text-center rounded-md bg-red-100 border border-red-300 text-red-500';
            return;
          }
          const orders = await response.json();
          if (orders.length === 0) {
            dashboardMessage.textContent = 'Nessun ordine trovato.';
            dashboardMessage.className = 'p-4 text-center rounded-md text-[#5c728a]'; // Neutral message
          } else {
            dashboardMessage.textContent = ''; // Clear loading message
            dashboardMessage.className = 'p-4 text-center rounded-md'; 
            orders.forEach(order => {
              ordersTableBody.appendChild(createOrderRowElement(order));
            });
          }
        } catch (error) {
          console.error('Error fetching orders:', error);
          dashboardMessage.textContent = 'Errore di connessione durante il caricamento degli ordini.';
           dashboardMessage.className = 'p-4 text-center rounded-md bg-red-100 border border-red-300 text-red-500';
        }
      }
      
      // New Order Modal Logic
      if (newOrderButton) {
        newOrderButton.addEventListener('click', () => {
          newOrderModal.classList.remove('hidden');
          newOrderMessage.textContent = '';
          newOrderForm.reset();
        });
      }
      if (closeModalButton) {
        closeModalButton.addEventListener('click', () => newOrderModal.classList.add('hidden'));
      }
      if (cancelOrderButton) {
        cancelOrderButton.addEventListener('click', () => newOrderModal.classList.add('hidden'));
      }
      if (newOrderForm) {
        newOrderForm.addEventListener('submit', async function(event) {
          event.preventDefault();
          submitNewOrderButton.disabled = true;
          newOrderMessage.textContent = 'Creazione ordine in corso...';
          newOrderMessage.className = 'mt-4 text-center p-2 rounded-md bg-blue-100 border border-blue-300 text-blue-500';

          const formData = new FormData(newOrderForm);
          const data = {
            user_id: parseInt(formData.get('userId')), // Ensure user_id is an integer
            items_description: formData.get('itemsDescription'),
            pickup_date: formData.get('pickupDate') ? new Date(formData.get('pickupDate')).toISOString() : null,
            delivery_date: formData.get('deliveryDate') ? new Date(formData.get('deliveryDate')).toISOString() : null,
            total_price: parseFloat(formData.get('totalPrice'))
          };

          // Filter out null dates if not provided
          if (!formData.get('pickupDate')) delete data.pickup_date;
          if (!formData.get('deliveryDate')) delete data.delivery_date;
          if (isNaN(data.total_price)) delete data.total_price;


          try {
            const response = await fetch('/api/orders', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            if (response.status === 401 || response.status === 403) {
              window.location.href = 'login.html';
              return;
            }
            
            const result = await response.json();
            if (response.ok) {
              newOrderMessage.textContent = 'Ordine creato con successo!';
              newOrderMessage.className = 'mt-4 text-center p-2 rounded-md bg-green-100 border border-green-300 text-green-500';
              setTimeout(() => {
                newOrderModal.classList.add('hidden');
                fetchAndRenderOrders(); // Refresh table
              }, 1500);
            } else {
              newOrderMessage.textContent = `Errore creazione ordine: ${result.message || response.statusText}`;
              newOrderMessage.className = 'mt-4 text-center p-2 rounded-md bg-red-100 border border-red-300 text-red-500';
            }
          } catch (error) {
            console.error('Error creating order:', error);
            newOrderMessage.textContent = 'Errore di connessione durante la creazione dell\'ordine.';
            newOrderMessage.className = 'mt-4 text-center p-2 rounded-md bg-red-100 border border-red-300 text-red-500';
          } finally {
            submitNewOrderButton.disabled = false;
          }
        });
      }

      // Initial fetch of orders
      fetchAndRenderOrders();
      
      // Add event listeners for disabled links
      document.querySelectorAll('.disabled-link').forEach(link => {
        link.addEventListener('click', function(event) {
          event.preventDefault();
          alert('Funzionalità non ancora implementata.');
        });
        // Add some visual indication of being disabled (can also be done with CSS)
        link.style.opacity = '0.5';
        link.style.cursor = 'not-allowed';
      });

      // Logout button functionality (already present from previous task)
      const logoutButton = document.getElementById('logoutButton');
      if (logoutButton) {
        logoutButton.addEventListener('click', async function () {
          try {
            const response = await fetch('/api/logout', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              }
            });
            if (response.ok) {
              window.location.href = 'login.html';
            } else {
              const result = await response.json().catch(() => ({message: "Logout failed"}));
              alert(result.message || 'Logout failed. Please try again.');
            }
          } catch (error) {
            console.error('Error during logout:', error);
            alert('An error occurred during logout. Please try again.');
          }
        });
      }
    });
  </script>
</html>
